context("test-background-separation.R Test Separation of Signature from Background")

test_that("Test Separation of Signature from Background 1", {
  set.seed(1099,"L'Ecuyer-CMRG")
  
  spectra <- mSigAct::nitrosamine.examples$catSBS96[ , 1:3]

  spectra.catalog.type <- attr(spectra, "catalog.type", exact = TRUE)
  if (is.null(spectra.catalog.type)) {
    # We should not have to do this, but we need
    # to check if/why the catalog.type seems to be NULL
    # in Travis-CI. Perhaps"[" works differently on
    # Travis-CI?
    warning("is.null(spectra.catalog.type)")
  }
  
  attr(spectra, "abundance")    <- 
    attr(mSigAct::nitrosamine.examples$catSBS96, "abundance", exact = TRUE)
  
  attr(spectra, "catalog.type") <-
    attr(mSigAct::nitrosamine.examples$catSBS96, "catalog.type", exact = TRUE)

  attr(spectra, "region") <-
    attr(mSigAct::nitrosamine.examples$catSBS96, "region", exact = TRUE)

  retval <- 
    SeparateSignatureFromBackground(
      spectra     = spectra,
      bg.sig.info = mSigAct::HepG2.background.info,
      m.opts      = NULL,
      start.b.fraction = 0.5)
  
  expected.sig <-
    c(
      0.0311093318889706,
      0.0084706307706262,
      0.00298881240551565,
      0.0103450148027531,
      0.0193581682934539,
      0.00518167247558129,
      0.00245636313204726,
      0.00905364604971065,
      0.0120841949800299,
      0.0044215356212372,
      0.00124238928900125,
      0.00679860605868145,
      0.0201384909414484,
      0.00789715296177787,
      0.00170048116135243,
      0.0123151962736123,
      0.0045262573459591,
      0.00314319079836859,
      0.000437349452668207,
      0.00349207213269948,
      0.00247092411292886,
      0.00212494319366331,
      0.000608802437012856,
      0.00191500014674152,
      0.000878748897490704,
      0.00362760025828435,
      0.00106661968951831,
      0.00243272994117449,
      0.0043762934349364,
      0.00383797692855781,
      0.000543242912546325,
      0.00612930530367745,
      0.0348249369564348,
      0.0211200875591835,
      0.00619649697582928,
      0.0176394685894629,
      0.0132786214340163,
      0.00805509588401969,
      0.00302697880995316,
      0.00636999864300961,
      0.0100336786893395,
      0.00917926653794931,
      0.0019547078604204,
      0.00952364743204063,
      0.0216830667159302,
      0.0178199517294944,
      0.00285688045765289,
      0.0156659937891589,
      0.0303312768528855,
      0.0245732611493527,
      0.0380475986633198,
      0.0233590090196688,
      0.00539830499582501,
      0.00778885802489583,
      0.0156039377498501,
      0.00723893483892536,
      0.0136272352752837,
      0.0102296944796823,
      0.0150932163159572,
      0.011391126183244,
      0.00885435811841832,
      0.0079247948524054,
      0.0137275338709563,
      0.00659449802449782,
      0.0308205544064947,
      0.0227048436926169,
      0.0146399759619406,
      0.0240367287044764,
      0.0103136153485451,
      0.0267213228027168,
      0.0133525372694459,
      0.0125230431730855,
      0.0279099898982814,
      0.0254046579123872,
      0.0175823966768981,
      0.0228788620422986,
      0.0100764915177185,
      0.017397495317465,
      0.00557800854749396,
      0.0093720836814781,
      0.0081502242229876,
      0.00578263230593004,
      0.00873953076028997,
      0.00722111830099288,
      0.00177247235928424,
      0.00264075689870613,
      0.00409243036380882,
      0.00268792540993682,
      0.00298805709294593,
      0.0068361518516725,
      0.00585042279680859,
      0.00397009933603321,
      0.00244973166746345,
      0.00350096539300193,
      0.00293264797483114,
      0.00304272062222302
    )
  
  testthat::expect_equal(retval$inferred.target.sig, expected.sig,
                         tolerance = 1e-3)
})
